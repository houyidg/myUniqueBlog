# 收集网络流量数据

应用程序产生的网络流量对运行设备的电池寿命减少产生重大的影响。为了优化网络流量，你既要测量流量大小又要区分流量的来源。有一些网络请求可能直接来自于用户的操作，一些来自于你应用程序的代码，或者有一些来自于服务端和应用程序交互。

网络流量工具（DDMS工具的部分功能）能让你查看什么时候以什么方式利用网络传输数据

这个课程通过标记源码展示怎样去测量和分类网络请求，然后去部署，测试和可视化应用程序网络流量

## 标记网络请求

应用程序因为多种原因使用手机网络硬件。为了能够正确的优化应用程序使用网络资源，必须知道应用程序使用了多少次网络和使用的原因。为了进行性能分析，你应该将网络硬件分解为以下几类别：

   1. 用户发起的网络请求：由用户发起的氢气，例如一个用户使用app更新文章列表
   2. app发起的网络请求：由android应用程序发起的请求去缓存未读取的缓存文章，而不是满足用户的操作
   3. 服务端发起的请求：由服务端发起的请求并不是满足用户的操作，例如一个新可用的通知
   
下面这个程序向你展示用三大类请求类型之一的常量如何去标识你程序源代码。网络流量工具就是用不同的颜色代表不同类型的流量，因此你可以单独的看见和优化每个网络流量。这里描述的技术报告了基于应用程序中线程执行的网络流量，你可以将其标识为用户、应用程序或者服务器源。

1. 在你的应用程序开发工程中定义三个常量来代表不同的网络使用类型：
2. 找到三种类型使用网络请求的接口
3. 基于上一步发现的类，在每个使用网络资源的线程中加入setThreadStatsTag(int)方法来标记应用程序使用网络流量，例如：
  
```
    if (BuildConfig.NETWORK_TEST && Build.VERSION.SDK_INT >= 14) {
        try {
            TrafficStats.setThreadStatsTag(USER_INITIATED)
            // make network request using HttpClient.execute()
        } finally {
            TrafficStats.clearThreadStatsTag()
        }
    }
```

## 配置一个网络测试build类型

## 部署网络测试Apk

## 运行网络流量工具
    DDMS ——> Network Statistics
    清理app 缓存数据：adb shell pm clear package.name.of.app

使用标记网络流量帮助你可视化分析每个请求类别，即在网路流量统计工具里可以看到每种类型的网络请求颜色不一样，如图：![avatar](/photo/network_traffic_colors.png)

